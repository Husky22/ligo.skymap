# This is a prebuilt Docker container that contains all of the dependencies.
# It is prebuilt to speed up continuous integration.
# The Dockerfile is stored on the 'docker' branch.
image: containers.ligo.org/leo-singer/ligo.skymap

stages:
  - sdist
  - build
  - deploy

sdist:
  stage: sdist
  script:
    - python3 setup.py sdist
  artifacts:
    paths:
      - dist/
    expire_in: 20 minutes

# Build receipe for standalone wheels on Linux
.wheel:manylinux1: &wheel-manylinux1
  # This container is derived from the official manylinux image provided by
  # python.org (see PEP 513), and includes all of the LALSuite
  # build-dependencies.
  image: containers.ligo.org/lscsoft/lalsuite-manylinux:master
  stage: build
  variables:
    GIT_STRATEGY: none
  before_script:
    - tar --strip-components 1 -xf dist/*
  script:
    # Build and install LALSuite
    - PYPREFIX=/opt/python/$(echo ${CI_JOB_NAME} | sed 's/.*:\(.*\)-manylinux1/\1/')
    - ${PYPREFIX}/bin/python setup.py bdist_wheel
    - auditwheel repair dist/*.whl
  artifacts:
    paths:
      - wheelhouse
    expire_in: 5 minutes

# Build receipe for standalone wheels on macOS
.wheel:macos: &wheel-macos
  tags:
    - macos
  stage: build
  variables:
    GIT_STRATEGY: none
  before_script:
    - tar --strip-components 1 -xf dist/*
  script:
    - PYVERS=$(echo ${CI_JOB_NAME} | sed 's/.*:cp\(.\)\(.\).*/\1.\2/')
    # Enter virtualenv so that we have a controlled version of Numpy
    - virtualenv-${PYVERS} env
    - source env/bin/activate
    - pip install -q delocate numpy==1.7.0
    # Build and audit wheel
    - python setup.py bdist_wheel
    - delocate-wheel -v -w wheelhouse dist/*.whl
    # FIXME: shell workers don't clean up after themselves!
    - rm -rf dist
  artifacts:
    paths:
      - wheelhouse

# Build wheels for all supported platforms
wheel:cp34-cp34m-manylinux1:
  <<: *wheel-manylinux1
wheel:cp35-cp35m-manylinux1:
  <<: *wheel-manylinux1
wheel:cp36-cp36m-manylinux1:
  <<: *wheel-manylinux1
wheel:cp35-cp35m-macosx:
  <<: *wheel-macos
wheel:cp36-cp36m-macosx:
  <<: *wheel-macos

test:
  stage: build
  variables:
    CFLAGS: -coverage
    GIT_STRATEGY: none
  before_script:
    - tar --strip-components 1 -xf dist/*
  script:
    # Run tests
    - python3 setup.py test --coverage -vv --args='-vv'
    # Write gcovr test coverage
    - mkdir gcovr
    - gcovr build/temp*/src -r . --html --html-detail -o gcovr/index.html
  artifacts:
    paths:
      - .coverage
      - build/temp.*/src/*.gc*
      - gcovr/
      - htmlcov/
    expire_in: 5 minutes

docs:
  stage: build
  variables:
    GIT_STRATEGY: none
  before_script:
    - tar --strip-components 1 -xf dist/*
  script:
    - python3 setup.py build_docs
  artifacts:
    paths:
      - docs/_build/html
    expire_in: 5 minutes

coverage:c:
  variables:
    GIT_STRATEGY: none
  coverage: '/^TOTAL\s+.*\s+(\d+\.?\d*)%/'
  stage: deploy
  before_script:
    - tar --strip-components 1 -xf dist/*
  script:
    # Display coverage summary
    - gcovr build/temp*/src -r .

coverage:py:
  variables:
    GIT_STRATEGY: none
  coverage: '/^TOTAL\s+.*\s+(\d+\.?\d*)%/'
  stage: deploy
  before_script:
    - tar --strip-components 1 -xf dist/*
  script:
    # Print coverage summary
    - python3 -m coverage report

pages:
  variables:
    GIT_STRATEGY: none
  stage: deploy
  script:
    - mv docs/_build/html public
    - mkdir -p public/cov
    - mv gcovr public/cov/c
    - mv htmlcov public/cov/py
    - mv dist public/dist
    - mv wheelhouse/* public/dist
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - master
